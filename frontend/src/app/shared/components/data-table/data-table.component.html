<div class="data-table-container relative">
  <!-- Header con búsqueda y controles -->
  <div class="flex flex-col gap-4 mb-6" *ngIf="config.searchable || config.pagination">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
      <!-- Búsqueda -->
      <div class="relative flex-1 max-w-sm" *ngIf="config.searchable">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <lucide-icon [img]="searchIcon" class="h-4 w-4 text-base-content/50" />
        </div>
        <input
          type="text"
          class="input input-bordered w-full pl-10 pr-10 text-sm font-sans"
          [placeholder]="config.searchPlaceholder || 'Buscar...'"
          [value]="state().search"
          (input)="onSearch($event)"
        />
        <button
          *ngIf="state().search"
          type="button"
          class="absolute inset-y-0 right-0 pr-3 flex items-center hover:text-base-content/80 transition-colors tooltip tooltip-left"
          data-tip="Limpiar búsqueda"
          (click)="clearSearch()"
        >
          <lucide-icon [img]="clearSearchIcon" class="h-4 w-4 text-base-content/50" />
        </button>
      </div>

      <!-- Selector de elementos por página -->
      <div class="flex items-center gap-2" *ngIf="config.pagination">
        <span class="text-sm text-base-content/70">Mostrar</span>
        <select
          class="select select-bordered select-sm text-sm font-sans"
          [value]="state().itemsPerPage"
          (change)="onItemsPerPageChange($event)"
        >
          <option
            *ngFor="let option of config.itemsPerPageOptions || [10, 25, 50]"
            [value]="option"
          >
            {{ option }}
          </option>
        </select>
        <span class="text-sm text-base-content/70">registros</span>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-wrapper overflow-x-auto">
    <table class="table w-full"
           [class.table-striped]="config.striped"
           [class.table-hover]="config.hoverable">
      <!-- Header -->
      <thead *ngIf="config.showHeader !== false">
        <tr>
          <th
            *ngFor="let column of visibleColumns()"
            [class]="column.class"
            [style.width]="column.width"
            [class.cursor-pointer]="column.sortable"
            (click)="onSort(column.field)"
            class="text-sm font-medium px-3 py-2"
            style="color: #6b7280;"
          >
            <div class="flex items-center gap-2">
              <span>{{ column.header }}</span>
              <div class="flex flex-col" *ngIf="column.sortable">
                <lucide-icon
                  [img]="sortAscIcon"
                  class="h-3 w-3"
                  [ngClass]="{
                    'text-primary': getSortActive(column.field, 'ASC'),
                    'text-base-content/30': !getSortActive(column.field, 'ASC')
                  }" />
                <lucide-icon
                  [img]="sortDescIcon"
                  class="h-3 w-3"
                  [ngClass]="{
                    'text-primary': getSortActive(column.field, 'DESC'),
                    'text-base-content/30': !getSortActive(column.field, 'DESC')
                  }" />
              </div>
            </div>
          </th>
          <th *ngIf="hasActions()" class="w-24 text-center text-sm font-medium px-3 py-2" style="color: #6b7280;">Acciones</th>
        </tr>
      </thead>

      <!-- Body -->
      <tbody>
        <!-- Empty -->
        <tr *ngIf="!state().loading && state().data.length === 0">
          <td [attr.colspan]="totalColumns()" class="text-center py-8 text-base-content/50">
            {{ config.emptyMessage || 'No se encontraron registros' }}
          </td>
        </tr>

        <!-- Data rows -->
        <ng-container *ngFor="let row of state().data; trackBy: trackByFn">
          <!-- Fila principal -->
          <tr class="relative">
            <!-- Columnas visibles -->
            <td
              *ngFor="let column of visibleColumns(); let i = index"
              [class]="column.class"
              class="relative text-sm px-3 py-2"
              style="color: #6b7280;"
            >
              <ng-container [ngSwitch]="column.template">
                <!-- Image template -->
                <div *ngSwitchCase="'image'" class="avatar">
                  <div class="w-10 h-10 rounded-full">
                    <img
                      [src]="formatCellValue(row, column)"
                      [alt]="column.header"
                      class="w-full h-full object-cover"
                      (error)="onImageError($event)"
                    />
                  </div>
                </div>

                <!-- Badge template -->
                <span *ngSwitchCase="'badge'"
                      class="badge"
                      [class]="getBadgeClass(getCellValue(row, column))">
                  {{ formatCellValue(row, column) }}
                </span>

                <!-- Date template -->
                <span *ngSwitchCase="'date'">
                  {{ formatDate(getCellValue(row, column)) }}
                </span>

                <!-- Custom template -->
                <div *ngSwitchCase="'custom'" [innerHTML]="column.render!(getCellValue(row, column), row)"></div>

                <!-- Default text template -->
                <span *ngSwitchDefault>
                  {{ formatCellValue(row, column) }}
                </span>
              </ng-container>

              <!-- Floating expansion button (only on first column if has hidden columns) -->
              <button
                *ngIf="hasHiddenColumns() && i === 0"
                (click)="toggleRowExpansion(row)"
                class="btn btn-xs btn-circle bg-gray-400 hover:bg-gray-500 border-gray-400 absolute bottom-1 left-1 shadow-lg opacity-60 hover:opacity-80 transition-opacity z-10"
                [attr.aria-label]="row.expanded ? 'Colapsar fila' : 'Expandir fila'"
              >
                <svg
                  [class.rotate-45]="row.expanded"
                  class="w-3 h-3 transition-transform duration-200"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
              </button>
            </td>

            <!-- Actions column -->
            <td *ngIf="hasActions()" class="text-center px-3 py-2">
              <div class="join inline-flex">
                <!-- Botón principal (acción primary) -->
                <ng-container *ngFor="let action of getVisibleActions(row)">
                  <button
                    *ngIf="action.primary"
                    type="button"
                    class="join-item btn btn-sm bg-white border-gray-200 hover:bg-gray-50 tooltip tooltip-left flex items-center gap-1.5 px-3 py-2.5 font-normal text-sm font-sans"
                    style="color: #6b7280;"
                    [attr.data-tip]="action.label"
                    (click)="executeAction(action, row)"
                  >
                    <lucide-icon
                      *ngIf="action.icon"
                      [img]="action.icon"
                      class="h-3.5 w-3.5"
                      style="color: #6b7280;" />
                    <span class="font-normal text-sm font-sans" style="color: #6b7280;">{{ action.label }}</span>
                  </button>
                </ng-container>

                <!-- Botón de acciones adicionales -->
                <div class="relative"
                     *ngIf="getSecondaryActions(row).length > 0">
                  <button
                    type="button"
                    class="join-item btn btn-sm bg-white border-gray-200 hover:bg-gray-50 tooltip tooltip-left font-normal px-3 py-2.5 font-sans"
                    style="color: #6b7280;"
                    [attr.data-tip]="'Más acciones'"
                    (click)="toggleActionMenu($event, row)"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3" style="color: #6b7280;"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </button>
                </div>
              </div>
            </td>
          </tr>

          <!-- Fila expandida con columnas ocultas -->
          <tr *ngIf="hasHiddenColumns() && isRowExpanded(row)" class="bg-base-200/50">
            <td [attr.colspan]="totalColumns()" class="py-2 text-sm" style="color: #6b7280;">
              <div class="px-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm">
                  <div *ngFor="let column of hiddenColumns()" class="flex">
                    <span class="font-medium text-base-content/70 mr-2">{{ column.header }}:</span>
                    <span class="text-sm" style="color: #6b7280;">
                      <ng-container [ngSwitch]="column.template">
                        <!-- Date template -->
                        <span *ngSwitchCase="'date'">
                          {{ formatDate(getCellValue(row, column)) }}
                        </span>

                        <!-- Badge template -->
                        <span *ngSwitchCase="'badge'"
                              class="badge badge-sm"
                              [class]="getBadgeClass(getCellValue(row, column))">
                          {{ formatCellValue(row, column) }}
                        </span>

                        <!-- Default -->
                        <span *ngSwitchDefault>
                          {{ formatCellValue(row, column) }}
                        </span>
                      </ng-container>
                    </span>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-6"
       *ngIf="config.pagination && state().data.length > 0">
    <!-- Información de registros -->
    <div class="text-sm text-base-content/70">
      Mostrando {{ from() }} a {{ to() }} de {{ state().totalRecords }} registros
    </div>

    <!-- Controles de paginación -->
    <div class="join" *ngIf="state().totalPages > 1">
      <!-- Primera página -->
      <button
        class="join-item btn btn-sm tooltip tooltip-bottom"
        data-tip="Primera página"
        [disabled]="state().currentPage === 1"
        (click)="goToPage(1)"
      >
        «
      </button>

      <!-- Página anterior -->
      <button
        class="join-item btn btn-sm tooltip tooltip-bottom"
        data-tip="Página anterior"
        [disabled]="state().currentPage === 1"
        (click)="goToPage(state().currentPage - 1)"
      >
        ‹
      </button>

      <!-- Ellipsis inicial -->
      <button class="join-item btn btn-sm btn-disabled" *ngIf="paginationRange().showFirstEllipsis">
        ...
      </button>

      <!-- Números de página -->
      <button
        *ngFor="let page of paginationRange().pages"
        class="join-item btn btn-sm"
        [class.btn-active]="page === state().currentPage"
        (click)="goToPage(page)"
      >
        {{ page }}
      </button>

      <!-- Ellipsis final -->
      <button class="join-item btn btn-sm btn-disabled" *ngIf="paginationRange().showLastEllipsis">
        ...
      </button>

      <!-- Página siguiente -->
      <button
        class="join-item btn btn-sm tooltip tooltip-bottom"
        data-tip="Página siguiente"
        [disabled]="state().currentPage === state().totalPages"
        (click)="goToPage(state().currentPage + 1)"
      >
        ›
      </button>

      <!-- Última página -->
      <button
        class="join-item btn btn-sm tooltip tooltip-bottom"
        data-tip="Última página"
        [disabled]="state().currentPage === state().totalPages"
        (click)="goToPage(state().totalPages)"
      >
        »
      </button>
    </div>
  </div>
</div>

<!-- Action Menu Popover -->
<div *ngIf="showActionMenu"
     class="fixed inset-0 z-50"
     (click)="closeActionMenu()">
  <div class="absolute bg-white rounded-lg shadow-xl border border-gray-200 py-1 min-w-32"
       [style.top.px]="actionMenuPosition.top"
       [style.left.px]="actionMenuPosition.left"
       (click)="$event.stopPropagation()">
    <button
      *ngFor="let action of currentMenuActions"
      type="button"
      class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 flex items-center gap-2"
      [class.text-red-600]="action.variant === 'danger'"
      (click)="executeAction(action, currentMenuRow!); closeActionMenu()"
    >
      <lucide-icon
        *ngIf="action.icon"
        [img]="action.icon"
        class="h-3 w-3" />
      {{ action.label }}
    </button>
  </div>
</div>

<!-- Loading Overlay -->
<div *ngIf="state().loading"
     class="absolute inset-0 bg-white/20 backdrop-blur-[1px] flex items-center justify-center z-10 rounded-lg">
  <div class="flex flex-col items-center gap-3 bg-white/90 backdrop-blur-sm rounded-lg px-4 py-3 shadow-lg">
    <span class="loading loading-spinner loading-md text-primary"></span>
    <span class="text-sm text-gray-700 font-medium">{{ config.loadingMessage || 'Cargando datos...' }}</span>
  </div>
</div>
